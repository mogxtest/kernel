name: BlueOS Standalone CI
 
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
 
concurrency:
  group: ${{ github.repository }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: true
 
jobs:
  build-system:
    # ä»…åœ¨åŒ…å«"start build"ä¸”PR/Issueå¼€æ”¾æ—¶è§¦å‘
    if: |
      contains(github.event.comment.body, 'start build') &&
      (
        (github.event.issue.state == 'open') ||
        (github.event.pull_request.state == 'open')
      )
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --cpus 8 --memory 16G
      
    env:
      ORCHESTRATOR_TOKEN: ${{ secrets.ORCHESTRATOR_TOKEN }}
      MANIFEST_REPO: https://github.com/blueos-repo/manifests
      
    steps:
      # æ­¥éª¤1: åˆå§‹è®¾ç½®å’ŒçŠ¶æ€é€šçŸ¥
      - name: Initialize and notify
        id: init
        run: |
          # ç¡®å®šè§¦å‘å™¨ç±»å‹
          if [ -n "${{ github.event.issue.pull_request }}" ]; then
            echo "trigger_type=pr" >> $GITHUB_OUTPUT
            echo "source_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "trigger_type=issue" >> $GITHUB_OUTPUT
            echo "source_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
           
          # æ„å»ºçŠ¶æ€é“¾æ¥
          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          
          # å‘é€åˆå§‹é€šçŸ¥
          curl -s -X POST \
            -H "Authorization: Bearer $ORCHESTRATOR_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${{ steps.init.outputs.source_number }}/comments" \
            -d "{
              \"body\": \"ğŸ”µ BlueOS CI æ„å»ºå·²å¯åŠ¨ï¼\\n\\n[æŸ¥çœ‹æ„å»ºè¿›åº¦]($RUN_URL)\"
            }"
            
          # æ·»åŠ æ„å»ºä¸­æ ‡ç­¾
          curl -s -X POST \
            -H "Authorization: Bearer $ORCHESTRATOR_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${{ steps.init.outputs.source_number }}/labels" \
            -d '{"labels":["build-in-progress"]}'
            
          # ä¿å­˜è¿è¡ŒURL
          echo "run_url=$RUN_URL" >> $GITHUB_OUTPUT
 
      # æ­¥éª¤2: æå–PRé“¾æ¥
      - name: Extract PR links
        id: extract-prs
        run: |
          # æå–æ‰€æœ‰PRé“¾æ¥
          PR_LINKS=$(echo "${{ github.event.comment.body }}" | grep -o 'https://github.com/[^/ ]*/pull/[0-9]*' | sort | uniq)
           
          # å¦‚æœæ²¡æœ‰é“¾æ¥ï¼Œæ·»åŠ å½“å‰PR
          if [ -z "$PR_LINKS" ] && [ "${{ steps.init.outputs.trigger_type }}" == "pr" ]; then
            CURRENT_PR="https://github.com/$GITHUB_REPOSITORY/pull/${{ steps.init.outputs.source_number }}"
            PR_LINKS="$CURRENT_PR"
          fi
          
          # è½¬æ¢ä¸ºJSONæ•°ç»„
          PR_LINKS_JSON=$(echo "$PR_LINKS" | jq -R -s 'split("\n") | map(select(. != ""))')
          echo "pr_links=$PR_LINKS_JSON" >> $GITHUB_OUTPUT
          
          echo "Detected PRs:"
          echo "$PR_LINKS"
 
      # æ­¥éª¤3: éªŒè¯PRçŠ¶æ€
      - name: Validate PRs
        run: |
          # å®‰è£…å¿…è¦å·¥å…·
          sudo apt-get update
          sudo apt-get install -y jq
           
          PR_LINKS='${{ steps.extract-prs.outputs.pr_links }}'
          
          # éªŒè¯æ¯ä¸ªPRçŠ¶æ€
          INVALID_COUNT=0
          echo "$PR_LINKS" | jq -r '.[]' | while read link; do
            # è§£æPRä¿¡æ¯
            PARTS=($(echo "$link" | sed -E 's|https://github.com/([^/]+)/([^/]+)/pull/([0-9]+)|\1 \2 \3|'))
            OWNER=${PARTS[0]}
            REPO=${PARTS[1]}
            PR_NUM=${PARTS[2]}
            
            echo "Validating PR: $OWNER/$REPO#$PR_NUM"
            
            # è·å–PRè¯¦ç»†ä¿¡æ¯
            PR_JSON=$(curl -s -H "Authorization: Bearer $ORCHESTRATOR_TOKEN" \
              "https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUM")
            
            state=$(echo "$PR_JSON" | jq -r '.state')
            merged=$(echo "$PR_JSON" | jq -r '.merged')
            mergeable=$(echo "$PR_JSON" | jq -r '.mergeable')
            
            if [ "$state" != "open" ] || [ "$merged" == "true" ] || [ "$mergeable" != "true" ]; then
              echo "::error::PR $OWNER/$REPO#$PR_NUM is not buildable"
              echo "::error::State: $state, Merged: $merged, Mergeable: $mergeable"
              INVALID_COUNT=$((INVALID_COUNT+1))
            fi
          done
          
          if [ $INVALID_COUNT -gt 0 ]; then
            echo "::error::Found $INVALID_COUNT invalid PRs"
            exit 1
          fi
 
      # æ­¥éª¤4: è®¾ç½®æ„å»ºç¯å¢ƒ
      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y repo git-lfs python3-pip openjdk-11-jdk
          pip3 install PyGithub
           
          git config --global user.name "BlueOS CI Bot"
          git config --global user.email "ci@blueos.org"
          git config --global advice.detachedHead false
 
      # æ­¥éª¤5: åˆå§‹åŒ–ä»“åº“
      - name: Initialize repo workspace
        run: |
          mkdir -p blueos
          cd blueos
          repo init -u $MANIFEST_REPO -m blueos.xml
           
          # ä½¿ç”¨æ·±åº¦å…‹éš†å’Œç¼“å­˜ä¼˜åŒ–
          repo sync -j8 --no-tags --optimized-fetch --force-sync \
            --current-branch --no-clone-bundle
 
      # æ­¥éª¤6: åº”ç”¨PRå˜æ›´
      - name: Apply PR changes
        run: |
          cd blueos
           
          # è¿›åº¦é€šçŸ¥
          RUN_URL='${{ steps.init.outputs.run_url }}'
          curl -s -X POST \
            -H "Authorization: Bearer $ORCHESTRATOR_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${{ steps.init.outputs.source_number }}/comments" \
            -d "{
              \"body\": \"ğŸ”„ æ­£åœ¨åº”ç”¨PRå˜æ›´... [æŸ¥çœ‹è¿›åº¦]($RUN_URL)\"
            }"
          
          # åº”ç”¨æ¯ä¸ªPR
          PR_LINKS='${{ steps.extract-prs.outputs.pr_links }}'
          echo "$PR_LINKS" | jq -r '.[]' | while read link; do
            PARTS=($(echo "$link" | sed -E 's|https://github.com/([^/]+)/([^/]+)/pull/([0-9]+)|\1 \2 \3|'))
            OWNER=${PARTS[0]}
            REPO=${PARTS[1]}
            PR_NUM=${PARTS[2]}
            
            echo "Applying PR: $OWNER/$REPO#$PR_NUM"
            
            # æŸ¥æ‰¾é¡¹ç›®è·¯å¾„
            project_path=$(repo list | grep "$OWNER/$REPO" | awk '{print $1}')
            
            if [ -z "$project_path" ]; then
              echo "::error::Project path not found for $OWNER/$REPO"
              exit 1
            fi
            
            cd "$project_path"
            
            # è·å–PRè¯¦ç»†ä¿¡æ¯
            PR_JSON=$(curl -s -H "Authorization: Bearer $ORCHESTRATOR_TOKEN" \
              "https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUM")
            
            head_owner=$(echo "$PR_JSON" | jq -r '.head.repo.owner.login')
            head_repo=$(echo "$PR_JSON" | jq -r '.head.repo.name')
            head_ref=$(echo "$PR_JSON" | jq -r '.head.ref')
            head_sha=$(echo "$PR_JSON" | jq -r '.head.sha')
            base_ref=$(echo "$PR_JSON" | jq -r '.base.ref')
            
            # æ·»åŠ å¼€å‘è€…è¿œç¨‹ä»“åº“
            git remote add pr-remote "https://github.com/$head_owner/$head_repo.git" || true
            git fetch pr-remote "${head_sha}"
            
            # ç¡®ä¿ä¸»çº¿æœ€æ–°
            git fetch origin
            git checkout -B ci-base "origin/$base_ref"
            
            # åˆ›å»ºPRåˆ†æ”¯å¹¶åˆå¹¶
            git checkout -b "pr-$PR_NUM" "$head_sha"
            git merge ci-base -m "Merge base into PR for CI testing"
            
            if [ $? -ne 0 ]; then
              echo "::error::Merge conflict in $project_path for PR $PR_NUM"
              exit 1
            fi
            
            cd - >/dev/null
          done
 
      # æ­¥éª¤7: æ‰§è¡Œæ„å»º
      - name: Build BlueOS
        run: |
          cd blueos
           
          # è¿›åº¦é€šçŸ¥
          RUN_URL='${{ steps.init.outputs.run_url }}'
          curl -s -X POST \
            -H "Authorization: Bearer $ORCHESTRATOR_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${{ steps.init.outputs.source_number }}/comments" \
            -d "{
              \"body\": \"ğŸ”¨ ç¼–è¯‘è¿›è¡Œä¸­... [æŸ¥çœ‹è¿›åº¦]($RUN_URL)\\né¢„è®¡è€—æ—¶: 60-90åˆ†é’Ÿ\"
            }"
          
          # è®¾ç½®æ„å»ºç¯å¢ƒ
          source build/envsetup.sh
          
          # é€‰æ‹©è®¾å¤‡é…ç½®
          lunch blueos_device-eng
          
          # å¹¶è¡Œæ„å»º
          make -j$(nproc) all
        
        # è¶…æ—¶è®¾ç½®
        timeout-minutes: 120
 
      # æ­¥éª¤8: å¤„ç†ç»“æœ
      - name: Handle build result
        id: build-result
        run: |
          if [ $? -eq 0 ]; then
            echo "::set-output name=status::success"
            echo "::set-output name=message::âœ… BlueOS æ„å»ºæˆåŠŸ"
            echo "::set-output name=label::build-success"
          else
            echo "::set-output name=status::failure"
            echo "::set-output name=message::âŒ BlueOS æ„å»ºå¤±è´¥"
            echo "::set-output name=label::build-failed"
          fi
 
      # æ­¥éª¤9: å‘é€æœ€ç»ˆé€šçŸ¥
      - name: Final notification
        env:
          GITHUB_TOKEN: ${{ secrets.ORCHESTRATOR_TOKEN }}
        run: |
          # æ„å»ºç»“æœå‚æ•°
          STATUS='${{ steps.build-result.outputs.status }}'
          MESSAGE='${{ steps.build-result.outputs.message }}'
          LABEL='${{ steps.build-result.outputs.label }}'
          RUN_URL='${{ steps.init.outputs.run_url }}'
           
          # ç§»é™¤æ„å»ºä¸­æ ‡ç­¾
          curl -s -X DELETE \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${{ steps.init.outputs.source_number }}/labels/build-in-progress"
            
          # æ·»åŠ ç»“æœæ ‡ç­¾
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${{ steps.init.outputs.source_number }}/labels" \
            -d "{\"labels\":[\"$LABEL\"]}"
            
          # å‘é€ç»“æœè¯„è®º
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${{ steps.init.outputs.source_number }}/comments" \
            -d "{
              \"body\": \"$MESSAGE\\n\\næ„å»ºæ—¥å¿—: $RUN_URL\"
            }"
